<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ui-bootstrap4@3.0.6/dist/ui-bootstrap-csp.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/angular-ui/bower-ui-grid/ui-grid.min.css">
    <link rel="stylesheet" href="../css/button.css">
    <link rel="stylesheet" href="../css/main-styles.css">
    <style type="text/css">
        [ng\:cloak], [ng-cloak], .ng-cloak {
            display: none !important;
        }
    </style>
    <title>CitiScreening Records Management System</title>
</head>
<body ng-app="update" ng-cloak class="ng-cloak">
<div ng-controller="AppController">
    <p class="h5 text-center" style="padding-top: 20px">Update Records</p>
    <div class="container">
        <hr class="my-4" />
        <div class="container grid-box">
            <div class="row px-3 py-2"></div>
            <div id="grid1" class="update-grid" ui-grid="gridOptions1" ui-grid-resize-columns ui-grid-selection
                 ui-grid-exporter ui-grid-edit ui-grid-row-edit ng-if="recordType === 'CUSTOMER'"></div>
            <div id="grid2" class="update-grid" ui-grid="gridOptions2" ui-grid-resize-columns ui-grid-selection
                 ui-grid-exporter ui-grid-edit ui-grid-row-edit ng-if="recordType === 'TRANSACTION'"></div>
            <div class="row px-3 py-2"></div>
        </div>
        <div class="row px-3 py-2">
            <div class="row ml-auto mr-0">
                <label for="SOEID">Please enter your SOEID:</label>
                <input type="text" id="SOEID" name="SOEID" ng-model="SOEID" required>
                <div class="m-2 p-1" style="width: auto;">
                    <button class="btn btn-md btn-primary" ng-disabled="checkSOEIDAndChangedFields()" ng-click="sendPatchRequest()"
                    >Make Changes</button>
                </div>
                <div class="m-2 p-1" style="width: auto;">
                    <button class="btn btn-md btn-primary" ng-click="cancel()">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.js"
        integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.min.js"
        integrity="sha256-eGE6blurk5sHj+rmkfsGYeKyZx3M4bG+ZlFyA7Kns7E=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.7/angular.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.7/angular-touch.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.7/angular-animate.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.7/angular-aria.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ui-bootstrap4@3.0.6/dist/ui-bootstrap-tpls.js"></script>

<script src="http://ui-grid.info/docs/grunt-scripts/csv.js"></script>
<script src="http://ui-grid.info/docs/grunt-scripts/pdfmake.js"></script>
<script src="http://ui-grid.info/docs/grunt-scripts/vfs_fonts.js"></script>
<script src="http://ui-grid.info/docs/grunt-scripts/lodash.min.js"></script>
<script src="http://ui-grid.info/docs/grunt-scripts/jszip.min.js"></script>
<script src="http://ui-grid.info/docs/grunt-scripts/excel-builder.dist.js"></script>
<script src="https://cdn.jsdelivr.net/gh/angular-ui/bower-ui-grid/ui-grid.min.js"></script>
<script>
    'use strict';
    var app = angular.module('update', ['ui.grid', 'ui.grid', 'ui.grid.resizeColumns', 'ui.grid.selection', 'ui.grid.exporter',
        'ui.grid.edit', 'ui.grid.rowEdit', 'ui.bootstrap']);

    app.controller('AppController', ['$window', '$scope', 'uiGridConstants', '$interval', '$uibModal',
        function($window, $scope, uiGridConstants, $interval, $uibModal) {
            $scope.recordType = $window.opener.scopeToShare.recordType;
            $scope.rowData = $window.opener.scopeToShare.getSelectedRowData();

            $scope.recordsToJSON = function(records) {
                var requestData = [];
                if ($scope.recordType === "CUSTOMER") {
                    for (var i = 0; i < records.length; i++) {
                        var auxCustomerData =
                            {
                                record:
                                    {
                                        id: records[i].id,
                                        buDetails:
                                            {
                                                bizProdId: records[i].bizProdId,
                                                bizUnitId: records[i].bizUnitId,
                                                businessEscalationPointOfContact: records[i].businessEscalationPointOfContact,
                                                businessId: records[i].businessId,
                                                connectivityProtocol: records[i].connectivityProtocol,
                                                country: records[i].country,
                                                csInstance: records[i].csInstance,
                                                csiId: records[i].csiId,
                                                cwUatContactName: records[i].cwUatContactName,
                                                cwVersion: records[i].cwVersion,
                                                cxBusinessGreenzone: records[i].cxBusinessGreenzone,
                                                cxScreeningBusinessUnitName: records[i].cxScreeningBusinessUnitName,
                                                gomCompliant: records[i].gomCompliant,
                                                impactToBusiness: records[i].impactToBusiness,
                                                interfaceAppId: records[i].interfaceAppId,
                                                interfaceApplicationName: records[i].interfaceApplicationName,
                                                operationEntity: records[i].operationEntity,
                                                opsComplianceContacts: records[i].opsComplianceContacts,
                                                productId: records[i].productId,
                                                region: records[i].region,
                                                rulesetMapped: records[i].rulesetMapped,
                                                sector: records[i].sector,
                                                sourceTechContact: records[i].sourceTechContact,
                                                timezone: records[i].timezone,
                                                updateHistory: records[i].updateHistory,
                                                wfBusinessGreenzone: records[i].wfBusinessGreenzone,
                                                wfBusinessUnitNameDisplayValue: records[i].wfBusinessUnitNameDisplayValue,
                                                workflowFlag: records[i].workflowFlag,
                                                workflowInstance: records[i].workflowInstance
                                            }
                                    },
                                requestor: $scope.SOEID
                            };
                        requestData.push(JSON.stringify(auxCustomerData));
                    }
                }
                else {
                    for (var j = 0; j < records.length; j++) {
                        var auxTransactionData =
                            {
                                record:
                                    {
                                        id: records[j].id,
                                        buDetails:
                                            {
                                                anyBatchComponent: records[j].anyBatchComponent,
                                                batchesOrPeaksForRealtimeVolumes: records[j].batchesOrPeaksForRealtimeVolumes,
                                                businessEscalationPointOfContact: records[j].businessEscalationPointOfContact,
                                                businessHotline: records[j].businessHotline,
                                                businessId: records[j].businessId,
                                                connectivityProtocol: records[j].connectivityProtocol,
                                                country: records[j].country,
                                                csiId: records[j].csiId,
                                                dailyOnlineVolumesExpected: records[j].dailyOnlineVolumesExpected,
                                                escalationPath1stLevelSupport: records[j].escalationPath1stLevelSupport,
                                                escalationPath2ndLevelSupport: records[j].escalationPath2ndLevelSupport,
                                                firstLevelEscalation: records[j].firstLevelEscalation,
                                                hotlineNumber: records[j].hotlineNumber,
                                                impactToProductProcessor: records[j].impactToProductProcessor,
                                                initialScreeningResponseSla: records[j].initialScreeningResponseSla,
                                                interfaceAppId: records[j].interfaceAppId,
                                                interfaceApplicationName: records[j].interfaceApplicationName,
                                                interfaceConnectivityDoc: records[j].interfaceConnectivityDoc,
                                                operationEntity: records[j].operationEntity,
                                                productId: records[j].productId,
                                                productProcessor: records[j].productProcessor,
                                                productProcessorGroupDl: records[j].productProcessorGroupDl,
                                                productProcessorScreeningResponseCutoffTime: records[j].productProcessorScreeningResponseCutoffTime,
                                                productProcessorSnowGroupName: records[j].productProcessorSnowGroupName,
                                                productProcessorStandardGreenzones: records[j].productProcessorStandardGreenzones,
                                                region: records[j].region,
                                                retryMechanism: records[j].retryMechanism,
                                                rulesetMapped: records[j].rulesetMapped,
                                                scheduleForRealtimeVolumes: records[j].scheduleForRealtimeVolumes,
                                                secondLevelEscalation: records[j].secondLevelEscalation,
                                                sector: records[j].sector,
                                                sourceTechContacts: records[j].sourceTechContact,
                                                thresholdSetForTimeouts: records[j].thresholdSetForTimeouts,
                                                txScreeningBusinessUnitName: records[j].txScreeningBusinessUnitName,
                                                uniqueProductId: records[j].uniqueProductId,
                                                updateHistory: records[j].updateHistory,
                                                wfBusinessGreenzone: records[j].wfBusinessGreenzone,
                                                workflowFlag: records[j].workflowFlag,
                                                workflowInstance: records[j].workflowInstance,
                                                workflowOperationsContacts: records[j].workflowOperationsContacts,
                                                workflowOperationsWorkSchedule: records[j].workflowOperationsWorkSchedule
                                            }
                                    },
                                requestor: $scope.SOEID
                            };
                        requestData.push(JSON.stringify(auxTransactionData));
                    }
                }
                console.log("The records were stringified.");
                console.log(requestData);
                return requestData;
            };

            $scope.showUpdateHistoryModal = function(id) {
                $window.opener.scopeToShare.showUpdateHistoryModal(id);
            };
            $scope.editedRecords = [];
            $scope.addChangedRecord = function (editedRecord) {
                console.log("The row was just pushed to editedRecords: ");
                $scope.editedRecords.push(editedRecord);
            };
            $scope.getNumberOfChangedRecords = function () {
                return $scope.editedRecords.length;
            };
            $scope.displayChangedRecords = function () {
                console.log($scope.editedRecords);
                var thing = JSON.parse($scope.editedRecords);
                console.log(thing);
            };

            $scope.sendPatchRequest = function() {
                  var data = $scope.recordsToJSON($scope.editedRecords);
                  console.log("After the json format has been created");
                  console.log(data);
                  $window.opener.scopeToShare.updateRecords(data);
            };

            var updateHistoryCellTemplate = '<div align="center"><a ng-click="grid.appScope.showUpdateHistoryModal(row.entity.id)"><img src="../images/history-img.png" height="34" width="34"></a></div>';

            $scope.gridOptions1 = {
                enableHorizontalScrollbar: uiGridConstants.scrollbars.WHEN_NEEDED,
                enableVerticalScrollbar: uiGridConstants.scrollbars.WHEN_NEEDED,
                enableColumnResizing: true,
                enableSorting: true,
                enableFullRowSelection: true,
                selectionRowHeaderWidth: 35,
                rowHeight: 35,
                enableSelectAll: true,
                onRegisterApi: function (gridApi) {
                    $scope.grid1Api = gridApi;

                    gridApi.edit.on.afterCellEdit($scope, function(rowEntity) {
                        //Here is where the main functionality starts
                        console.log("A row was just edited: ");
                        console.log(rowEntity);
                        $scope.addChangedRecord(rowEntity);
                    });

                },
                data: $scope.rowData
            };

            $scope.gridOptions1.columnDefs = $window.opener.scopeToShare.gridOptions1.columnDefs;
            $scope.gridOptions1.columnDefs[0].enableCellEdit = false;
            var numCxColumns = $scope.gridOptions1.columnDefs.length;
            $scope.gridOptions1.columnDefs[numCxColumns - 1].enableCellEdit = false;
            $scope.gridOptions1.columnDefs[numCxColumns - 1].cellTemplate = updateHistoryCellTemplate;

            $scope.gridOptions2 = {
                enableHorizontalScrollbar: uiGridConstants.scrollbars.WHEN_NEEDED,
                enableVerticalScrollbar: uiGridConstants.scrollbars.WHEN_NEEDED,
                enableColumnResizing: true,
                enableSorting: true,
                enableFullRowSelection: true,
                selectionRowHeaderWidth: 35,
                rowHeight: 35,
                enableSelectAll: true,
                onRegisterApi: function (gridApi) {
                    $scope.grid1Api = gridApi;

                    gridApi.edit.on.afterCellEdit($scope, function(rowEntity) {
                        //Here is where the main functionality starts
                        console.log("A row was just edited: ");
                        console.log(rowEntity);
                        $scope.addChangedRecord(rowEntity);
                    });
                },
                data: $scope.rowData
            };

            $scope.gridOptions2.columnDefs = $window.opener.scopeToShare.gridOptions2.columnDefs;
            $scope.gridOptions2.columnDefs[0].enableCellEdit = false;
            var numTxColumns = $scope.gridOptions2.columnDefs.length;
            $scope.gridOptions2.columnDefs[numTxColumns - 1].enableCellEdit = false;
            $scope.gridOptions2.columnDefs[numTxColumns - 1].cellTemplate = updateHistoryCellTemplate;

            $scope.cancel = function () {
                $window.close();
            };

            $scope.makeChanges = function () {
                $window.close(); //delete this later

            };

            $scope.checkSOEIDAndChangedFields = function () {
                return !($scope.SOEID)/* || $scope.getNumberOfChangedRecords() === 0*/;
            };
        }]);
</script>
</body>
</html>